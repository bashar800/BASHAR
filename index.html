<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مواقيت الصلاة</title>
    <style>
        body {
            font-family: 'Amiri', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            direction: rtl;
        }
        h1 {
            margin-bottom: 20px;
            font-size: 3rem;
            text-align: center;
            color: #2C3E50;
        }
        .clock {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #16A085;
            font-weight: bold;
        }
        .date {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #2980B9;
        }
        .next-prayer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            width: 90%;
        }
        .next-prayer div {
            border: 2px solid #27AE60;
            padding: 15px;
            margin: 5px;
            font-size: 1.5rem;
            text-align: center;
            width: 45%;
            background-color: #ECF0F1;
            color: #2C3E50;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        table {
            border-collapse: collapse;
            width: 95%;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        table, th, td {
            border: 1px solid #27AE60;
        }
        th, td {
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
        }
        th {
            background-color: #2C3E50;
            color: #fff;
        }
        td {
            color: #34495E;
        }
    </style>
</head>
<body>
    <h1>مواقيت الصلاة في الكرك، الأردن</h1>
    <div class="date" id="date">جاري تحميل التاريخ...</div>
    <div class="clock" id="clock">جاري تحميل الوقت الحالي...</div>
    <div class="next-prayer">
        <div id="nextPrayer">الصلاة التالية: جاري التحميل...</div>
        <div id="timeToNextPrayer">المتبقي: جاري التحميل...</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>الصلاة</th>
                <th>وقت الأذان</th>
                <th>وقت الإقامة</th>
            </tr>
        </thead>
        <tbody id="prayerTimes">
            <tr><td>الفجر</td><td id="fajrAdhan">-</td><td id="fajrIqama">-</td></tr>
            <tr><td>الشروق</td><td id="shorooqAdhan">-</td><td id="shorooqIqama">-</td></tr>
            <tr><td>الظهر</td><td id="dhuhrAdhan">-</td><td id="dhuhrIqama">-</td></tr>
            <tr><td>العصر</td><td id="asrAdhan">-</td><td id="asrIqama">-</td></tr>
            <tr><td>المغرب</td><td id="maghribAdhan">-</td><td id="maghribIqama">-</td></tr>
            <tr><td>العشاء</td><td id="ishaAdhan">-</td><td id="ishaIqama">-</td></tr>
        </tbody>
    </table>

    <script>
        // Function to update the current time
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('clock').innerText = `${hours}:${minutes}:${seconds}`;
        }

        // Function to update the date in Gregorian and Hijri formats
        function updateDate() {
            const now = new Date();

            // Gregorian date
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const gregorianDate = now.toLocaleDateString('ar-EG', options);

            // Hijri date
            const hijriOptions = { calendar: 'islamic', year: 'numeric', month: 'long', day: 'numeric' };
            const hijriDate = now.toLocaleDateString('ar-EG', hijriOptions);

            document.getElementById('date').innerText = `${gregorianDate} / ${hijriDate}`;
        }

        // Fetch prayer times from Aladhan API with timezone
        async function fetchPrayerTimes() {
            try {
                const response = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Al-Karak&country=Jordan&method=2&school=1&timezone=Asia/Amman');
                const data = await response.json();
                const timings = data.data.timings;

                // Update Adhan times
                document.getElementById('fajrAdhan').innerText = timings.Fajr;
                document.getElementById('shorooqAdhan').innerText = timings.Sunrise;
                document.getElementById('dhuhrAdhan').innerText = timings.Dhuhr;
                document.getElementById('asrAdhan').innerText = timings.Asr;
                document.getElementById('maghribAdhan').innerText = timings.Maghrib;
                document.getElementById('ishaAdhan').innerText = timings.Isha;

                // Update Iqama times (example: 10 minutes after Adhan)
                const iqamaOffset = 10;
                document.getElementById('fajrIqama').innerText = calculateIqamaTime(timings.Fajr, iqamaOffset);
                document.getElementById('shorooqIqama').innerText = '-';
                document.getElementById('dhuhrIqama').innerText = calculateIqamaTime(timings.Dhuhr, iqamaOffset);
                document.getElementById('asrIqama').innerText = calculateIqamaTime(timings.Asr, iqamaOffset);
                document.getElementById('maghribIqama').innerText = calculateIqamaTime(timings.Maghrib, iqamaOffset);
                document.getElementById('ishaIqama').innerText = calculateIqamaTime(timings.Isha, iqamaOffset);
            } catch (error) {
                console.error('Error fetching prayer times:', error);
            }
        }

        // Helper function to calculate Iqama time
        function calculateIqamaTime(adhanTime, offset) {
            const [hours, minutes] = adhanTime.split(':').map(Number);
            const iqamaTime = new Date();
            iqamaTime.setHours(hours);
            iqamaTime.setMinutes(minutes + offset);
            return `${String(iqamaTime.getHours()).padStart(2, '0')}:${String(iqamaTime.getMinutes()).padStart(2, '0')}`;
        }

        // Function to send a signal via USB
        async function sendAdhanSignal() {
            try {
                const response = await fetch('/send-signal', { method: 'POST' });
                if (response.ok) {
                    console.log('Signal sent successfully.');
                } else {
                    console.error('Failed to send signal.');
                }
            } catch (error) {
                console.error('Error sending signal:', error);
            }
        }

        // Function to calculate the next prayer time
        function updateNextPrayer() {
            const now = new Date();
            const times = [
                { name: 'الفجر', time: document.getElementById('fajrAdhan').innerText },
                { name: 'الشروق', time: document.getElementById('shorooqAdhan').innerText },
                { name: 'الظهر', time: document.getElementById('dhuhrAdhan').innerText },
                { name: 'العصر', time: document.getElementById('asrAdhan').innerText },
                { name: 'المغرب', time: document.getElementById('maghribAdhan').innerText },
                { name: 'العشاء', time: document.getElementById('ishaAdhan').innerText }
            ];

            for (const prayer of times) {
                const [hours, minutes] = prayer.time.split(':').map(Number);
                const prayerTime = new Date();
                prayerTime.setHours(hours);
                prayerTime.setMinutes(minutes);
                prayerTime.setSeconds(0);

                if (prayerTime > now) {
                    const diff = Math.floor((prayerTime - now) / 1000);
                    if (diff === 0) {
                        sendAdhanSignal(); // Send signal at the exact Adhan time
                    }

                    const diffHours = Math.floor(diff / 3600);
                    const diffMinutes = Math.floor((diff % 3600) / 60);
                    const diffSeconds = diff % 60;

                    document.getElementById('nextPrayer').innerText = `الصلاة التالية: ${prayer.name} (${prayer.time})`;
                    document.getElementById('timeToNextPrayer').innerText = `المتبقي: ${diffHours} ساعة ${diffMinutes} دقيقة ${diffSeconds} ثانية`;
                    return;
                }
            }

            document.getElementById('nextPrayer').innerText = 'لا توجد صلاة قادمة اليوم';
            document.getElementById('timeToNextPrayer').innerText = '';
        }

        // Initialize
        updateClock();
        updateDate();
        fetchPrayerTimes(); // Fetch prayer times from API
        setInterval(updateClock, 1000); // Update the clock every second
        setInterval(updateNextPrayer, 1000); // Update next prayer every second
    </script>
</body>
</html>
